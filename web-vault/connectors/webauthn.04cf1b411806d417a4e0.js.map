{"version":3,"file":"connectors/webauthn.04cf1b411806d417a4e0.js","mappings":"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","sources":["webpack://@bitwarden/web-vault/webpack/bootstrap","webpack://@bitwarden/web-vault/./src/connectors/common.ts","webpack://@bitwarden/web-vault/./src/connectors/common-webauthn.ts","webpack://@bitwarden/web-vault/webpack/runtime/make namespace object","webpack://@bitwarden/web-vault/./src/connectors/webauthn.ts"],"sourcesContent":["// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","export function getQsParam(name: string) {\n  const url = window.location.href;\n  // eslint-disable-next-line\n  name = name.replace(/[\\[\\]]/g, \"\\\\$&\");\n  const regex = new RegExp(\"[?&]\" + name + \"(=([^&#]*)|&|#|$)\");\n  const results = regex.exec(url);\n\n  if (!results) {\n    return null;\n  }\n  if (!results[2]) {\n    return \"\";\n  }\n\n  return decodeURIComponent(results[2].replace(/\\+/g, \" \"));\n}\n\nexport function b64Decode(str: string, spaceAsPlus = false) {\n  if (spaceAsPlus) {\n    str = str.replace(/ /g, \"+\");\n  }\n\n  return decodeURIComponent(\n    Array.prototype.map\n      .call(atob(str), (c: string) => {\n        return \"%\" + (\"00\" + c.charCodeAt(0).toString(16)).slice(-2);\n      })\n      .join(\"\"),\n  );\n}\n","export function buildDataString(assertedCredential: PublicKeyCredential) {\n  const response = assertedCredential.response as AuthenticatorAssertionResponse;\n\n  const authData = new Uint8Array(response.authenticatorData);\n  const clientDataJSON = new Uint8Array(response.clientDataJSON);\n  const rawId = new Uint8Array(assertedCredential.rawId);\n  const sig = new Uint8Array(response.signature);\n\n  const data = {\n    id: assertedCredential.id,\n    rawId: coerceToBase64Url(rawId),\n    type: assertedCredential.type,\n    extensions: assertedCredential.getClientExtensionResults(),\n    response: {\n      authenticatorData: coerceToBase64Url(authData),\n      clientDataJson: coerceToBase64Url(clientDataJSON),\n      signature: coerceToBase64Url(sig),\n    },\n  };\n\n  return JSON.stringify(data);\n}\n\nexport function parseWebauthnJson(jsonString: string) {\n  const json = JSON.parse(jsonString);\n\n  const challenge = json.challenge.replace(/-/g, \"+\").replace(/_/g, \"/\");\n  json.challenge = Uint8Array.from(atob(challenge), (c) => c.charCodeAt(0));\n\n  json.allowCredentials.forEach((listItem: any) => {\n    // eslint-disable-next-line\n    const fixedId = listItem.id.replace(/\\_/g, \"/\").replace(/\\-/g, \"+\");\n    listItem.id = Uint8Array.from(atob(fixedId), (c) => c.charCodeAt(0));\n  });\n\n  return json;\n}\n\n// From https://github.com/abergs/fido2-net-lib/blob/b487a1d47373ea18cd752b4988f7262035b7b54e/Demo/wwwroot/js/helpers.js#L34\n// License: https://github.com/abergs/fido2-net-lib/blob/master/LICENSE.txt\nfunction coerceToBase64Url(thing: any) {\n  // Array or ArrayBuffer to Uint8Array\n  if (Array.isArray(thing)) {\n    thing = Uint8Array.from(thing);\n  }\n\n  if (thing instanceof ArrayBuffer) {\n    thing = new Uint8Array(thing);\n  }\n\n  // Uint8Array to base64\n  if (thing instanceof Uint8Array) {\n    let str = \"\";\n    const len = thing.byteLength;\n\n    for (let i = 0; i < len; i++) {\n      str += String.fromCharCode(thing[i]);\n    }\n    thing = window.btoa(str);\n  }\n\n  if (typeof thing !== \"string\") {\n    throw new Error(\"could not coerce to string\");\n  }\n\n  // base64 to base64url\n  // NOTE: \"=\" at the end of challenge is optional, strip it off here\n  thing = thing.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=*$/g, \"\");\n\n  return thing;\n}\n","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","// FIXME: Update this file to be type safe and remove this and next line\n// @ts-strict-ignore\nimport { b64Decode, getQsParam } from \"./common\";\nimport { buildDataString, parseWebauthnJson } from \"./common-webauthn\";\n\nrequire(\"./webauthn.scss\");\n\nconst mobileCallbackUri = \"bitwarden://webauthn-callback\";\n\nlet parsed = false;\nlet webauthnJson: any;\nlet headerText: string = null;\nlet btnText: string = null;\nlet btnReturnText: string = null;\nlet parentUrl: string = null;\nlet parentOrigin: string = null;\nlet mobileResponse = false;\nlet stopWebAuthn = false;\nlet sentSuccess = false;\nlet obj: any = null;\n\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n  init();\n\n  parseParameters();\n  if (headerText) {\n    const header = document.getElementById(\"webauthn-header\");\n    header.innerText = decodeURI(headerText);\n  }\n  if (btnText) {\n    const button = document.getElementById(\"webauthn-button\");\n    button.innerText = decodeURI(btnText);\n    button.onclick = executeWebAuthn;\n  }\n});\n\nfunction init() {\n  start();\n  onMessage();\n  info(\"ready\");\n}\n\nfunction parseParameters() {\n  if (parsed) {\n    return;\n  }\n\n  parentUrl = getQsParam(\"parent\");\n  if (!parentUrl) {\n    error(\"No parent.\");\n    return;\n  } else {\n    parentUrl = decodeURIComponent(parentUrl);\n    parentOrigin = new URL(parentUrl).origin;\n  }\n\n  const version = getQsParam(\"v\");\n\n  if (version === \"1\") {\n    parseParametersV1();\n  } else {\n    parseParametersV2();\n  }\n  parsed = true;\n}\n\nfunction parseParametersV1() {\n  const data = getQsParam(\"data\");\n  if (!data) {\n    error(\"No data.\");\n    return;\n  }\n\n  webauthnJson = b64Decode(data);\n  headerText = getQsParam(\"headerText\");\n  btnText = getQsParam(\"btnText\");\n  btnReturnText = getQsParam(\"btnReturnText\");\n}\n\nfunction parseParametersV2() {\n  let dataObj: {\n    data: any;\n    headerText: string;\n    btnText: string;\n    btnReturnText: string;\n    callbackUri?: string;\n    mobile?: boolean;\n  } = null;\n  try {\n    dataObj = JSON.parse(b64Decode(getQsParam(\"data\")));\n  } catch (e) {\n    error(\"Cannot parse data.\");\n    return;\n  }\n\n  mobileResponse = dataObj.callbackUri != null || dataObj.mobile === true;\n  webauthnJson = dataObj.data;\n  headerText = dataObj.headerText;\n  btnText = dataObj.btnText;\n  btnReturnText = dataObj.btnReturnText;\n}\n\nfunction start() {\n  sentSuccess = false;\n\n  if (!(\"credentials\" in navigator)) {\n    error(\"WebAuthn is not supported in this browser.\");\n    return;\n  }\n\n  parseParameters();\n  if (!webauthnJson) {\n    error(\"No data.\");\n    return;\n  }\n\n  try {\n    obj = parseWebauthnJson(webauthnJson);\n  } catch (e) {\n    error(\"Cannot parse webauthn data.\");\n    return;\n  }\n\n  stopWebAuthn = false;\n\n  if (\n    mobileResponse ||\n    (navigator.userAgent.indexOf(\" Safari/\") !== -1 && navigator.userAgent.indexOf(\"Chrome\") === -1)\n  ) {\n    // Safari and mobile chrome blocks non-user initiated WebAuthn requests.\n  } else {\n    executeWebAuthn();\n  }\n}\n\nfunction executeWebAuthn() {\n  if (stopWebAuthn) {\n    return;\n  }\n\n  navigator.credentials.get({ publicKey: obj }).then(success).catch(error);\n}\n\nfunction onMessage() {\n  window.addEventListener(\n    \"message\",\n    (event) => {\n      if (!event.origin || event.origin === \"\" || event.origin !== parentOrigin) {\n        return;\n      }\n\n      if (event.data === \"stop\") {\n        stopWebAuthn = true;\n      } else if (event.data === \"start\" && stopWebAuthn) {\n        start();\n      }\n    },\n    false,\n  );\n}\n\nfunction error(message: string) {\n  if (mobileResponse) {\n    document.location.replace(mobileCallbackUri + \"?error=\" + encodeURIComponent(message));\n    returnButton(mobileCallbackUri + \"?error=\" + encodeURIComponent(message));\n  } else {\n    parent.postMessage(\"error|\" + message, parentUrl);\n  }\n}\n\nfunction success(assertedCredential: PublicKeyCredential) {\n  if (sentSuccess) {\n    return;\n  }\n\n  const dataString = buildDataString(assertedCredential);\n\n  if (mobileResponse) {\n    document.location.replace(mobileCallbackUri + \"?data=\" + encodeURIComponent(dataString));\n    returnButton(mobileCallbackUri + \"?data=\" + encodeURIComponent(dataString));\n  } else {\n    parent.postMessage(\"success|\" + dataString, parentUrl);\n    sentSuccess = true;\n  }\n}\n\nfunction info(message: string) {\n  if (mobileResponse) {\n    return;\n  }\n\n  parent.postMessage(\"info|\" + message, parentUrl);\n}\n\nfunction returnButton(uri: string) {\n  // provides 'return' button in case scripted navigation is blocked\n  const button = document.getElementById(\"webauthn-button\");\n  button.innerText = decodeURI(btnReturnText);\n  button.onclick = () => {\n    document.location.replace(uri);\n  };\n}\n"],"names":["__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","getQsParam","name","url","window","location","href","replace","results","RegExp","exec","decodeURIComponent","b64Decode","str","spaceAsPlus","Array","prototype","map","call","atob","c","charCodeAt","toString","slice","join","coerceToBase64Url","thing","isArray","Uint8Array","from","ArrayBuffer","len","byteLength","i","String","fromCharCode","btoa","Error","r","Symbol","toStringTag","Object","defineProperty","value","mobileCallbackUri","webauthnJson","parsed","headerText","btnText","btnReturnText","parentUrl","parentOrigin","mobileResponse","stopWebAuthn","sentSuccess","obj","parseParameters","error","URL","origin","data","parseParametersV1","dataObj","JSON","parse","e","callbackUri","mobile","parseParametersV2","start","navigator","jsonString","json","challenge","allowCredentials","forEach","listItem","fixedId","id","parseWebauthnJson","userAgent","indexOf","executeWebAuthn","credentials","get","publicKey","then","success","catch","message","document","encodeURIComponent","returnButton","parent","postMessage","assertedCredential","dataString","response","authData","authenticatorData","clientDataJSON","rawId","sig","signature","type","extensions","getClientExtensionResults","clientDataJson","stringify","buildDataString","uri","button","getElementById","innerText","decodeURI","onclick","addEventListener","event"],"sourceRoot":""}